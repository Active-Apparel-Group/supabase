# Supabase Tracking Schema Verification — Handover (2025-10-25)

**Author:** GitHub Copilot (GPT-5-Codex Preview)  
**Environment:** Supabase project `wjpbryjgtmmaqjbhjgap` (GREYSON pilot)

---

## Summary

Between 2025-10-24 and 2025-10-25 we validated the live Supabase tracking schema, confirmed exposed REST endpoints, and refreshed two internal documents (`02-supabase-schema-blueprint.md`, `03-import-and-api-plan.md`). All findings below derive from direct SQL metadata inspection and PostgREST smoke tests executed via MCP tooling.

## Key confirmations

| Area | Result |
| --- | --- |
| **Tables** | 17 operational tracking tables (folders, plans, styles, materials, timelines, template system, assignments, audit logs) plus 3 import log tables; all enumerated in the updated blueprint. |
| **Views** | 7 tracking views present (`tracking_*_summary`, `tracking_*_timeline_detail`, `tracking_timeline_template_detail`). No public synonyms. |
| **Functions & triggers** | Timeline calculation + cascade triggers present (`calculate_*`, `cascade_*`, `instantiate_timeline_from_template`, `recalculate_plan_timelines`). No `fn_upsert_*` routines yet. |
| **REST endpoints** | `/rest/v1/tracking_folder_summary`, `/tracking_plan_summary`, `/tracking_plan_style_summary`, `/tracking_plan_style_timeline_detail`, `/tracking_plan_material_summary`, `/tracking_plan_material_timeline_detail`, `/tracking_timeline_template_detail` all respond successfully (material endpoints currently empty). |
| **Enums** | Seven `tracking.*_enum` types populated; `ref_*` tables mirror these values with labels/colour metadata. |
| **Data snapshot** | GREYSON seed data includes 1 folder, 3 plans, 4 plan styles, 108 style milestones, 1 timeline template (27 nodes). Material tables remain empty pending imports. |

## Document updates

1. **`02-supabase-schema-blueprint.md`** — Rewritten to reflect the live schema (tables, views, enums, triggers, data counts, gaps, sample queries). Serves as the authoritative 2025-10-25 reference.
2. **`03-import-and-api-plan.md`** — Aligned with actual tables/views and the current REST surface. Explicitly calls out missing staging tables, upsert functions, and Edge Function deployment status. Added REST/GraphQL smoke tests and revised next steps.

## Outstanding work

- Create staging tables (`tracking.import_*`) and associated upsert SQL functions.
- Deploy `tracking-import-beproduct` (and companion functions) with retry/backoff and batch logging.
- Implement RLS policies scoped by JWT `brand_ids` and validate PostgREST/GraphQL restrictions.
- Populate material tables once trims import is finalised; retest material views/endpoints afterwards.
- Add Slack/webhook notifications when `import_batches.status = 'failed'`.

## Recommended next actions

1. Schedule engineering time to deliver the staging + upsert layer (prerequisite for production imports).
2. Stand up Edge Functions and hook them into Supabase cron for nightly GREYSON refreshes.
3. Coordinate with the portal team to ingest the refreshed REST endpoints and GraphQL nodes (naming changes: `tracking_*` rather than `public.v_*`).
4. Plan RLS rollout in tandem with auth—ensure tokens include `brand_ids`.
5. Re-run schema validation after material data lands to verify timeline triggers behave identically across style/material scopes.

## Artifacts

- ✅ `supabase-tracking/docs/02-supabase-schema-blueprint.md`
- ✅ `supabase-tracking/docs/03-import-and-api-plan.md`
- ✅ `supabase-tracking/docs/handover-2025-10-25.md` *(this document)*

Please treat this handover as the state-of-the-world snapshot for onboarding and follow-up planning. Reach out to the data engineering team if any discrepancies appear after future migrations.
